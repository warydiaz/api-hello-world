name: Deploy to OpenShift

on:
 workflow_run:
   workflows:
     - Build and Push to Quay.io
   types:
     - completed

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      # 1. Instalar cliente OpenShift
      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz -C /usr/local/bin
          chmod +x /usr/local/bin/oc

      # 2. Log in to OpenShift
      - name: Log in to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }}

      # 3. Set OpenShift project/namespace
      - name: Set OpenShift project
        run: |
          oc project ${{ secrets.OPENSHIFT_PROJECT }}

      # 4. Extract commit date and short SHA for the image tag
      - name: Set image tag
        id: set_tag
        run: |
          COMMIT_MESSAGE="${{ github.event.workflow_run.head_commit.message }}"
          COMMIT_TAG=$(echo $COMMIT_MESSAGE | awk '{print $NF}')
          echo "IMAGE_TAG=${COMMIT_TAG}" >> $GITHUB_ENV

      # 5. Deploy the application
      - name: Deploy to OpenShift
        run: |
          IMAGE="quay.io/${{ secrets.QUAY_USERNAME }}/api-hello-wworld:${{ env.IMAGE_TAG }}"
          oc set image deployment/api-hello-wworld api-hello-wworld=$IMAGE
          oc rollout restart deployment/api-hello-wworld

      # 6. Verify deployment status
      - name: Verify deployment
        run: |
          oc rollout status deployment/api-hello-wworld
